!function(e){var o={};function n(r){if(o[r])return o[r].exports;var t=o[r]={i:r,l:!1,exports:{}};return e[r].call(t.exports,t,t.exports,n),t.l=!0,t.exports}n.m=e,n.c=o,n.d=function(e,o,r){n.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,o){if(1&o&&(e=n(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var t in e)n.d(r,t,function(o){return e[o]}.bind(null,t));return r},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},n.p="",n(n.s=0)}([function(e,o,n){e.exports=n(1)},function(e,o,n){const r=n(2),t=r(),i=(n(3),n(4)),s=n(5),u=n(6),a=n(7),c=n(8),d=n(9),l=r.Router();var p=n(10).OAuth2Strategy;const f=u.model("Book",{name:String,id:String,orders_counter:Number}),g=u.model("UserBooks",{name:String,pass:String,googleId:String}),m=u.model("Orders",{productref:{type:u.Schema.Types.ObjectId,ref:"Book"},userref:{type:u.Schema.Types.ObjectId,ref:"UserBoks"},date:String,price:Number});c.use(new p({clientID:"130839017404-fkmhf5uccocbk9a1594klaenjcnhi57u.apps.googleusercontent.com",clientSecret:"MulxdYDE9AocU2QQqhM3a9e-",callbackURL:"http://gloob.eu:3000/auth/google/callback"},function(e,o,n,r){console.log(n),g.findOneAndUpdate({googleId:n.id},{name:n.displayName,pass:""},{upsert:!0},function(e,o){return r(e,o)})})),c.serializeUser(function(e,o){o(null,e)}),c.deserializeUser(function(e,o){o(null,e)});t.use(r.static("public")),t.use(s()),t.use(i.json()),t.use(i.urlencoded({extended:!0})),t.use(c.initialize()),t.use(c.session()),u.connect("mongodb://localhost:27017"),d.serve(l,f),t.use(l),t.addOrder=function(e,o){var n=new Promise((o,n)=>{f.findOne({name:e},function(e,n){o(n)})}),r=new Promise((e,n)=>{g.findOne({name:o},function(o,n){e(n)})});Promise.all([n,r]).then(e=>{order=new m({productref:e[0]._id,userref:e[1]._id,date:(new Date).toDateString(),price:e[0].orders_counter}),order.save()}).then(e=>console.log(e))},t.set("view engine","ejs"),t.get("/auth/google",c.authenticate("google",{scope:["https://www.googleapis.com/auth/plus.login"]})),t.get("/auth/google/callback",c.authenticate("google",{failureRedirect:"/login"}),function(e,o){console.log(e.user),o.cookie("uname",e.user.name,{maxAge:9e5,httpOnly:!0}),o.cookie("token","googleId:"+e.googleId,{maxAge:9e5,httpOnly:!0}),o.redirect("/")}),t.get("/",function(e,o){console.log(e.user),f.find(function(e,n){o.render("index",{products:n})})}),t.get("/orders/:uid",function(e,o){new Promise((o,n)=>{m.find({userref:e.params.uid},function(e,n){o(n)})}).then(e=>{o.send(e)})}),t.get("/products/:uid",async function(e,o){var n=await new Promise((o,n)=>{m.find({userref:e.params.uid}).populate("productref").exec((e,n)=>{if(e)throw e;o(n)})});o.send(JSON.stringify(n))}),t.get("/order/:id",function(e,o){""!==e.cookies.uname&&null!==e.cookies.uname&&""!=e.cookies.token&&null!=e.cookies.token||null!==e.user?(g.findOne({name:e.cookies.uname}),g.findOne({name:e.cookies.uname},(n,r)=>{r?f.find({id:e.params.id},function(n,i){i.forEach(o=>{o.id==e.params.id&&(o.orders_counter++,o.save(),t.addOrder(o.name,r.name))}),o.send("popo")}):o.send("nok")})):o.send("nok")}),t.get("/signup",function(e,o){o.render("signup")}),t.post("/register",function(e,o){hash=a.hash(e.body.pass,10,(n,r)=>{user=new g({name:e.body.user,pass:r}),user.save(),o.send("ok")})}),t.post("/login",function(e,o){g.findOne({name:e.body.user},(n,r)=>{r?a.compare(e.body.pass,r.pass,(n,r)=>{r?a.hash(e.body.user+e.body.pass,10,(n,r)=>{o.cookie("uname",e.body.user,{maxAge:9e5,httpOnly:!0}),o.cookie("token",r,{maxAge:9e5,httpOnly:!0}),o.send('ok ! <a href="/">retour</a>')}):o.send('NOok ! <a href="/">retour</a>')}):o.redirect("/")})}),t.listen(3e3,function(){console.log("Example app listening on port 3000!")})},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("ejs")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("cookie-parser")},function(e,o){e.exports=require("mongoose")},function(e,o){e.exports=require("bcrypt")},function(e,o){e.exports=require("passport")},function(e,o){e.exports=require("express-restify-mongoose")},function(e,o){e.exports=require("passport-google-oauth")}]);